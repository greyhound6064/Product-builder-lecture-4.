<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜¥ í”¼í•˜ê¸° ê²Œì„</title>
    <link rel="stylesheet" href="poop_style.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-90H1VQKDQP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-90H1VQKDQP');
    </script>
    <!-- MS Clarity tracking code -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "v2pz4gz1ko");
    </script>
</head>
<body>
    <div class="game-container">
        <h1>ğŸ’© ë˜¥ í”¼í•˜ê¸° ğŸ’©</h1>
        <div id="score-board">ì ìˆ˜: <span id="score">0</span> | ë¨¹ì€ ë˜¥: <span id="eaten-count">0</span></div>
        <div id="game-area">
            <div id="player"></div>
            <!-- ë˜¥ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
        <div class="controls">
            <button id="start-btn">ê²Œì„ ì‹œì‘</button>
            <button id="rank-btn" style="background-color: #f59e0b; margin-left: 10px;">ë­í‚¹ ë³´ê¸°</button>
            <p class="mobile-controls">PC: ë°©í–¥í‚¤ / ëª¨ë°”ì¼: í™”ë©´ ë“œë˜ê·¸</p>
        </div>
        
        <!-- Game Description Modal -->
        <div id="description-modal" class="hidden">
            <div class="modal-content">
                <h2>ê²Œì„ ì„¤ëª… ğŸ®</h2>
                <div style="text-align: left; margin: 20px 0; font-size: 1.1rem;">
                    <p>ğŸ’© <strong>ë˜¥</strong>ì„ ìš”ë¦¬ì¡°ë¦¬ í”¼í•˜ì„¸ìš”!</p>
                    <p>ğŸ” <strong>í–„ë²„ê±°</strong>ë¥¼ ë¨¹ìœ¼ë©´?</p>
                    <p style="color: #0ea5e9; font-weight: bold; padding-left: 20px;">âœ¨ 3ì´ˆê°„ ë¬´ì ! ë˜¥ì„ ë¨¹ì–´ì¹˜ìš°ì„¸ìš”! âœ¨</p>
                    <p>ë˜¥ì„ ë¨¹ìœ¼ë©´ ì¶”ê°€ ì ìˆ˜ë¥¼ íšë“í•  ìˆ˜ ìˆì–´ìš”.</p>
                </div>
                <button id="real-start-btn" style="background-color: #10b981; font-size: 1.5rem; padding: 15px 40px;">START</button>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="game-over-modal" class="hidden">
            <div class="modal-content">
                <h2>ìœ¼ì•…! ë¬»ì—ˆì–´ìš”! ğŸ˜±</h2>
                <p>ìµœì¢… ì ìˆ˜: <span id="final-score">0</span></p>
                <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="player-name" placeholder="ì´ë¦„ (3ê¸€ì ì´ë‚´)" maxlength="3" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                    <input type="password" id="player-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)" maxlength="4" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                    <input type="text" id="player-msg" placeholder="í•œë§ˆë”” (20ì ì´ë‚´)" maxlength="20" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                    <button id="submit-score-btn" style="background-color: #10b981;">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                </div>
                <div style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                    <button id="restart-btn">ë‹¤ì‹œ í•˜ê¸°</button>
                    <button id="view-rank-over-btn" style="background-color: #f59e0b;">ë­í‚¹ ë³´ê¸°</button>
                </div>
            </div>
        </div>

        <!-- Ranking Modal -->
        <div id="ranking-modal" class="hidden">
            <div class="modal-content" style="max-width: 500px; width: 90%;">
                <h2>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ ğŸ†</h2>
                <div id="ranking-list" style="max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 20px;">
                    <!-- ë­í‚¹ ì•„ì´í…œì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    <p>ë¡œë”©ì¤‘...</p>
                </div>
                <button id="close-rank-btn" style="background-color: #64748b;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <audio id="bgm" src="Overboard - The Grey Room _ Golden Palms.mp3" loop preload="auto"></audio>
    <audio id="poop-sound" src="ë¿Œì§.mp4" preload="auto"></audio>
    <audio id="yummy-sound" src="ì•¼ë¯¸.mp4" preload="auto"></audio>
    
    <!-- Firebase SDK & Ranking Logic -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBSWPyayT7YAJ6HqoZGsNpvYgjkkYNj2r0",
          authDomain: "product-builder-test-1feab.firebaseapp.com",
          projectId: "product-builder-test-1feab",
          storageBucket: "product-builder-test-1feab.firebasestorage.app",
          messagingSenderId: "912765779748",
          appId: "1:912765779748:web:09f882bd363e6451ad3db1",
          measurementId: "G-X6ZRK5D8VF"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const analytics = getAnalytics(app);
            console.log("Firebase & Analytics initialized");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        const submitBtn = document.getElementById('submit-score-btn');
        const rankBtn = document.getElementById('rank-btn');
        const viewRankOverBtn = document.getElementById('view-rank-over-btn'); // ìƒˆ ë²„íŠ¼
        const closeRankBtn = document.getElementById('close-rank-btn');
        const rankingModal = document.getElementById('ranking-modal');
        const rankingList = document.getElementById('ranking-list');

        // ì ìˆ˜ ì œì¶œ
        submitBtn.addEventListener('click', async () => {
            if (!db) { alert("ë­í‚¹ ì‹œìŠ¤í…œì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
            
            const name = document.getElementById('player-name').value;
            const pw = document.getElementById('player-pw').value;
            const msg = document.getElementById('player-msg').value;
            // finalScore is updated in poop_game.js logic, but accessible via DOM textContent
            const score = parseInt(document.getElementById('final-score').textContent, 10);
            const eatenCount = parseInt(document.getElementById('eaten-count').textContent, 10) || 0; // ë¨¹ì€ ë˜¥ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°

            if (!name || !pw) {
                alert("ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            try {
                await addDoc(collection(db, "ranks"), {
                    name: name,
                    password: pw,
                    message: msg,
                    score: score,
                    eatenCount: eatenCount, // ì €ì¥
                    date: new Date()
                });
                alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                submitBtn.disabled = true; // ì¤‘ë³µ ì œì¶œ ë°©ì§€
                submitBtn.textContent = "ì €ì¥ ì™„ë£Œ";
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("ì €ì¥ ì‹¤íŒ¨ ã… ã… ");
            }
        });

        // ë­í‚¹ ë³´ê¸° ê³µí†µ í•¨ìˆ˜
        const showRanking = async () => {
            rankingModal.classList.remove('hidden');
            if (!db) {
                rankingList.innerHTML = "<p>Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>";
                return;
            }
            
            rankingList.innerHTML = "<p>ë¡œë”©ì¤‘...</p>";
            try {
                const q = query(collection(db, "ranks"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                rankingList.innerHTML = "";
                if (querySnapshot.empty) {
                    rankingList.innerHTML = "<p>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</p>";
                } else {
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const eaten = data.eatenCount || 0; // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„± ì²˜ë¦¬
                        const item = document.createElement('div');
                        item.style.borderBottom = "1px solid #eee";
                        item.style.padding = "10px 0";
                        item.style.display = "flex";
                        item.style.justifyContent = "space-between";
                        item.innerHTML = `
                            <span><strong>${rank}ìœ„</strong> ${data.name}</span>
                            <div style="text-align: right;">
                                <span>${data.score}ì  <small style="color:#f59e0b;">(ğŸ’© ${eaten})</small></span><br>
                                <small style="color:#888;">${data.message || '-'}</small>
                            </div>
                        `;
                        rankingList.appendChild(item);
                        rank++;
                    });
                }
            } catch (e) {
                console.error("Error getting documents: ", e);
                rankingList.innerHTML = "<p>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>";
            }
        };

        rankBtn.addEventListener('click', showRanking);
        viewRankOverBtn.addEventListener('click', showRanking); // ê²Œì„ ì˜¤ë²„ ì°½ì—ì„œë„ ì‘ë™

        closeRankBtn.addEventListener('click', () => {
            rankingModal.classList.add('hidden');
        });
        
    </script>
    <script src="poop_game.js"></script>
</body>
</html>