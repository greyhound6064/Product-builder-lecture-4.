<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜¥ í”¼í•˜ê¸° ê²Œì„</title>
    <link rel="stylesheet" href="poop_style.css">
</head>
<body>
    <div class="game-container">
        <h1>ğŸ’© ë˜¥ í”¼í•˜ê¸° ğŸ’©</h1>
        <div id="score-board">ì ìˆ˜: <span id="score">0</span> | ë¨¹ì€ ë˜¥: <span id="eaten-count">0</span></div>
        <div id="game-area">
            <div id="player"></div>
            <!-- ë˜¥ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
        <div class="controls">
            <button id="start-btn">ê²Œì„ ì‹œì‘</button>
            <button id="rank-btn" style="background-color: #f59e0b; margin-left: 10px;">ë­í‚¹ ë³´ê¸°</button>
            <p class="mobile-controls">PC: ë°©í–¥í‚¤ / ëª¨ë°”ì¼: í™”ë©´ ë“œë˜ê·¸</p>
        </div>
        
        <!-- Game Over Modal -->
        <div id="game-over-modal" class="hidden">
            <div class="modal-content">
                <h2>ìœ¼ì•…! ë¬»ì—ˆì–´ìš”! ğŸ˜±</h2>
                <p>ìµœì¢… ì ìˆ˜: <span id="final-score">0</span></p>
                <div id="record-form" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="player-name" placeholder="ì´ë¦„ (3ê¸€ì ì´ë‚´)" maxlength="3" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                    <input type="password" id="player-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)" maxlength="4" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                    <input type="text" id="player-msg" placeholder="í•œë§ˆë”” (20ì ì´ë‚´)" maxlength="20" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                    <button id="submit-score-btn" style="background-color: #10b981;">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                </div>
                <div style="margin-top: 15px;">
                    <button id="restart-btn">ë‹¤ì‹œ í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <!-- Ranking Modal -->
        <div id="ranking-modal" class="hidden">
            <div class="modal-content" style="max-width: 500px; width: 90%;">
                <h2>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ ğŸ†</h2>
                <div id="ranking-list" style="max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 20px;">
                    <!-- ë­í‚¹ ì•„ì´í…œì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    <p>ë¡œë”©ì¤‘...</p>
                </div>
                <button id="close-rank-btn" style="background-color: #64748b;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <audio id="bgm" src="Overboard - The Grey Room _ Golden Palms.mp3" loop preload="auto"></audio>
    
    <!-- Firebase SDK & Ranking Logic -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBSWPyayT7YAJ6HqoZGsNpvYgjkkYNj2r0",
          authDomain: "product-builder-test-1feab.firebaseapp.com",
          projectId: "product-builder-test-1feab",
          storageBucket: "product-builder-test-1feab.firebasestorage.app",
          messagingSenderId: "912765779748",
          appId: "1:912765779748:web:09f882bd363e6451ad3db1",
          measurementId: "G-X6ZRK5D8VF"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const analytics = getAnalytics(app);
            console.log("Firebase & Analytics initialized");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        const submitBtn = document.getElementById('submit-score-btn');
        const rankBtn = document.getElementById('rank-btn');
        const closeRankBtn = document.getElementById('close-rank-btn');
        const rankingModal = document.getElementById('ranking-modal');
        const rankingList = document.getElementById('ranking-list');

        // ì ìˆ˜ ì œì¶œ
        submitBtn.addEventListener('click', async () => {
            if (!db) { alert("ë­í‚¹ ì‹œìŠ¤í…œì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
            
            const name = document.getElementById('player-name').value;
            const pw = document.getElementById('player-pw').value;
            const msg = document.getElementById('player-msg').value;
            // finalScore is updated in poop_game.js logic, but accessible via DOM textContent
            const score = parseInt(document.getElementById('final-score').textContent, 10);
            
            if (!name || !pw) {
                alert("ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            try {
                await addDoc(collection(db, "ranks"), {
                    name: name,
                    password: pw,
                    message: msg,
                    score: score,
                    date: new Date()
                });
                alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                submitBtn.disabled = true; // ì¤‘ë³µ ì œì¶œ ë°©ì§€
                submitBtn.textContent = "ì €ì¥ ì™„ë£Œ";
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("ì €ì¥ ì‹¤íŒ¨ ã… ã… ");
            }
        });

        // ë­í‚¹ ë³´ê¸°
        rankBtn.addEventListener('click', async () => {
            rankingModal.classList.remove('hidden');
            if (!db) {
                rankingList.innerHTML = "<p>Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>";
                return;
            }
            
            rankingList.innerHTML = "<p>ë¡œë”©ì¤‘...</p>";
            try {
                const q = query(collection(db, "ranks"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                rankingList.innerHTML = "";
                if (querySnapshot.empty) {
                    rankingList.innerHTML = "<p>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</p>";
                } else {
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const item = document.createElement('div');
                        item.style.borderBottom = "1px solid #eee";
                        item.style.padding = "10px 0";
                        item.style.display = "flex";
                        item.style.justifyContent = "space-between";
                        item.innerHTML = `
                            <span><strong>${rank}ìœ„</strong> ${data.name}</span>
                            <span>${data.score}ì  <small style="color:#888;">(${data.message || '-'})</small></span>
                        `;
                        rankingList.appendChild(item);
                        rank++;
                    });
                }
            } catch (e) {
                console.error("Error getting documents: ", e);
                rankingList.innerHTML = "<p>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>";
            }
        });

        closeRankBtn.addEventListener('click', () => {
            rankingModal.classList.add('hidden');
        });
        
    </script>
    <script src="poop_game.js"></script>
</body>
</html>